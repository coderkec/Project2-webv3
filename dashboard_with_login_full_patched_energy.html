<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team2 í†µí•© ëŒ€ì‹œë³´ë“œ v7.4 + AI(Ollama)</title>
  <style>
    :root{
      --bg-color:#f8fafc; --card-bg:#ffffff; --text-main:#1e293b; --text-sub:#64748b;
      --border:#e2e8f0; --accent:#8b5cf6; --accent-hover:#7c3aed; --shadow:rgba(0,0,0,0.05);
      --chat-user-bg:#8b5cf6; --chat-user-text:#fff;
      --dot-green:#10b981; --dot-red:#ef4444;

      --content-w: 980px;
      --chat-height: 380px;
    }
    body.dark-mode{
      --bg-color:#0f172a; --card-bg:#1e293b; --text-main:#f1f5f9; --text-sub:#94a3b8;
      --border:#334155; --accent:#a78bfa; --accent-hover:#8b5cf6; --shadow:rgba(0,0,0,0.3);
      --chat-user-bg:#6366f1;
    }
    *{margin:0;padding:0;box-sizing:border-box;transition:background .3s,color .3s;}
    html,body{
      height:100%; background:var(--bg-color); color:var(--text-main);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    }

    /* --- Login View --- */
    #loginView{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#f1f5f9; z-index:9999; }
    .login-shell{
      width:100%; max-width: 980px; display:grid; grid-template-columns: 1.1fr 0.9fr;
      background:white; border-radius:24px; box-shadow:0 25px 50px -12px rgba(0,0,0,.1); overflow:hidden;
    }
    .login-hero{
      padding:50px; color:#fff;
      background:linear-gradient(135deg,#4338ca 0%,#6d28d9 50%,#7c3aed 100%);
      display:flex; flex-direction:column; justify-content:center;
    }
    .login-panel{ padding:50px 40px; display:flex; flex-direction:column; justify-content:center; overflow-y:auto; max-height:90vh; }
    .login-title{font-size:22px;font-weight:900;color:#0f172a;margin-bottom:6px;}
    .login-desc{font-size:13px;color:#64748b;margin-bottom:18px;}
    .login-input{ width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:12px; outline:none; font-size:14px; margin-bottom:15px; }
    .login-input:focus{border-color:#8b5cf6;background:#fcfaff;}
    .btn-primary{ width:100%; padding:14px; border:none; border-radius:12px; background:#8b5cf6; color:#fff; font-weight:900; cursor:pointer; margin-bottom:10px; font-size:15px; }
    .btn-ghost{ width:100%; padding:14px; border:1px solid #e2e8f0; border-radius:12px; background:#fff; color:#475569; font-weight:900; cursor:pointer; font-size:15px; }
    .login-links{display:flex; justify-content:space-between; margin-top:20px; font-size:13px;}
    .link-btn{background:none;border:none;color:#8b5cf6;font-weight:900;cursor:pointer;font-size:13px;}
    .link-btn:hover{text-decoration:underline;color:#7c3aed;}
    .hidden{display:none !important;}
    #authExtra{margin-top:20px;padding-top:20px;border-top:1px solid #f1f5f9;}

    /* --- Dashboard Layout --- */
    #dashboardView{ min-height:100vh; display:flex; flex-direction:column; }
    .wrap{ width:min(var(--content-w), calc(100% - 40px)); margin:0 auto; }
    .page{ flex:1; min-height:0; display:flex; flex-direction:column; }
    .main-area{
      flex:1; min-height:0;
      display:flex; flex-direction:column;
      padding: 18px 0 0 0;
      gap: 14px;
    }
    .bottom-area{
      margin-top:auto;
      padding: 8px 0 18px 0;
    }

    /* ========================= TOP BAR ========================= */
    #toolbar{
      height:64px; margin-top:16px;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(14px);
      border:1px solid var(--border);
      border-radius:999px;
      box-shadow:0 6px 24px var(--shadow);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 18px; gap:12px;
      flex-shrink:0;
    }
    body.dark-mode #toolbar{ background: rgba(30,41,59,.88); }

    .tb-left{ display:flex; align-items:center; gap:10px; font-weight:900; min-width:210px; }
    .tb-logo{
      width:36px; height:36px; border-radius:999px; display:grid; place-items:center;
      background: rgba(139,92,246,.12); color: var(--accent); font-weight:900;
    }
    .tb-chip{ font-size:12px;background:#f1f5f9;color:var(--text-sub);padding:4px 12px;border-radius:999px;font-weight:900; }
    body.dark-mode .tb-chip{ background:#0b1220; border:1px solid #223047; }

    .tb-center{
      display:flex; align-items:center; gap:10px;
      flex:1; justify-content:center;
      overflow:auto; scrollbar-width:none;
    }
    .tb-center::-webkit-scrollbar{display:none;}

    .tb-ind{
      display:flex; align-items:center; gap:8px;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(248,250,252,.6);
      color: var(--text-sub);
      font-size:13px; font-weight:900;
      white-space:nowrap;
      cursor: default;
      user-select:none;
    }
    body.dark-mode .tb-ind{ background: rgba(15,23,42,.6); }
    .dot{width:8px;height:8px;border-radius:50%; background:var(--dot-red);}
    .ok .dot{background:var(--dot-green);}

    .tb-right{ display:flex; align-items:center; gap:8px; justify-content:flex-end; min-width:210px; }
    .tb-btn{
      padding:8px 14px; border:1px solid var(--border); background:var(--bg-color);
      border-radius:999px; font-size:12px; font-weight:900; cursor:pointer; color:var(--text-sub);
      transition:all .2s ease; white-space:nowrap;
    }
    .tb-btn:hover{ border-color:var(--accent); color:var(--accent); }

    /* ========================= CONTENT ========================= */
    .quote-card{
      background:var(--card-bg);
      border-radius:16px;
      padding:24px 34px;
      box-shadow:0 4px 20px var(--shadow);
      text-align:center;
      border:1px solid var(--border);
    }
    .quote-text{ font-size:18px; font-weight:700; }
    .quote-author{ margin-top:8px; color:var(--text-sub); font-weight:700; }

    .input-wrapper{ position:relative; width:100%; }
    .question-input{
      width:100%;
      padding:20px 60px 20px 26px;
      font-size:16px;
      border:2px solid var(--border);
      border-radius:999px;
      background:var(--card-bg);
      color:var(--text-main);
      outline:none;
      box-shadow:0 4px 15px var(--shadow);
    }
    .send-button{
      position:absolute; right:8px; top:50%;
      transform:translateY(-50%);
      width:48px; height:48px;
      border:none; border-radius:50%;
      background:linear-gradient(135deg,var(--accent) 0%,#6366f1 100%);
      color:#fff; cursor:pointer;
    }

    .example-questions{
      display:flex; flex-wrap:wrap; gap:10px;
      justify-content:center;
      margin-top: 10px;
      margin-bottom: 4px;
    }
    .example-btn{
      padding:8px 18px; background:var(--card-bg);
      border:1px solid var(--border); border-radius:999px;
      font-size:13px; font-weight:900; color:var(--text-sub);
      cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,.03);
      transition:all .2s;
    }
    .example-btn:hover{ border-color:var(--accent); color:var(--accent); }

    .chat-topbar{
      display:none;
      justify-content:flex-end;
      margin-top: -6px;
      margin-bottom: -10px;
    }
    .chat-topbar.active{ display:flex; }

    .clear-chat-out{
      padding:7px 12px;
      background: rgba(241,245,249,.9);
      border:1px solid var(--border);
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      color:var(--text-sub);
      cursor:pointer;
      transition: all .2s;
    }
    .clear-chat-out:hover{
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(139,92,246,.08);
    }
    body.dark-mode .clear-chat-out{
      background: rgba(30,41,59,.88);
      border-color: #334155;
      color: #cbd5e1;
    }

    .response-area{
      background:var(--card-bg);
      border-radius:20px;
      padding:16px 18px;
      box-shadow:0 4px 20px var(--shadow);
      border:1px solid var(--border);
      display:none;
      flex-direction:column;
      gap:10px;
      margin-top: 0px;
    }
    .response-area.active{ display:flex; }

    .chat-history{
      max-height: var(--chat-height);
      overflow:auto;
      padding-right:6px;
    }

    .chat-bubble{
      max-width:80%;
      border-radius:20px;
      padding:14px 18px;
      border:1px solid var(--border);
      background:var(--bg-color);
      line-height:1.5;
      font-size:15px;
      white-space:pre-wrap;
    }
    .chat-msg{ display:flex; margin:10px 0; }
    .chat-msg.user{ justify-content:flex-end; }
    .chat-msg.user .chat-bubble{
      background:var(--chat-user-bg);
      border-color:var(--chat-user-bg);
      color:var(--chat-user-text);
    }

    /* ========================= BOTTOM BLOCKS ========================= */
    .info-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:14px;
    }
    .info-card{
      background:rgba(255,255,255,.8);
      backdrop-filter:blur(12px);
      border-radius:16px;
      padding:14px 16px;
      border:1px solid rgba(255,255,255,.6);
      box-shadow:0 8px 32px rgba(0,0,0,.05);
      text-align:left;
      min-height:92px;
    }
    body.dark-mode .info-card{
      background:rgba(30,41,59,.85);
      border-color:rgba(255,255,255,.1);
    }
    .info-title{ display:flex; justify-content:space-between; font-size:12px; font-weight:900; color:var(--text-sub); margin-bottom:6px; }
    .badge{ font-size:11px; background:rgba(139,92,246,.1); color:var(--accent); padding:4px 8px; border-radius:6px; font-weight:900; }
    .info-value{ font-size:20px; font-weight:900; color:var(--text-main); margin-bottom:4px; }
    .info-sub{ font-size:12px; color:var(--text-sub); font-weight:900; }

    .hint-banner{
      margin-top:10px; padding:10px 16px; border-radius:14px;
      border:1px dashed var(--border);
      color:var(--text-sub);
      background:rgba(255,255,255,.65);
      backdrop-filter:blur(10px);
      box-shadow:0 4px 20px var(--shadow);
      font-size:13px; font-weight:900; display:none;
    }
    .hint-banner strong{ color:var(--text-main); }

    #guestHeader{
      height:60px; margin-top:16px;
      display:flex; justify-content:flex-end;
    }
    .gbtn{
      padding:8px 16px; background:rgba(255,255,255,.9);
      border:1px solid var(--border); border-radius:999px;
      font-size:13px; font-weight:900; cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,.05);
    }
    body.dark-mode .gbtn{ background: rgba(30,41,59,.88); color: var(--text-main); }

    @media (max-width: 980px){
      .info-grid{ grid-template-columns:repeat(2,1fr); }
      .login-shell{ grid-template-columns:1fr; }
      .login-hero{ display:none; }
      .tb-left{ min-width:auto; }
      .tb-right{ min-width:auto; }
    }
  </style>
</head>
<body>

  <div id="loginView">
    <div class="login-shell">
      <div class="login-hero">
        <h1>AI + API ê¸°ë°˜<br>í†µí•© ëŒ€ì‹œë³´ë“œ</h1>
        <p>Kubernetes ê¸°ë°˜ ì¸í”„ë¼ ê´€ì œ ë° ì‹¤ì‹œê°„<br>ë‚ ì”¨, ê°•ìˆ˜, ë¯¸ì„¸ë¨¼ì§€ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        <div style="margin-top:20px;">
          <span style="background:rgba(255,255,255,0.2); padding:5px 12px; border-radius:20px; font-size:12px; font-weight:900;">
            ğŸš€ v7.4 + Ollama
          </span>
        </div>
      </div>

      <div class="login-panel">
        <div class="login-title">í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹</div>
        <div class="login-desc">ë¡œê·¸ì¸í•˜ì—¬ ëŒ€ì‹œë³´ë“œì— ì ‘ì†í•˜ì„¸ìš”.</div>

        <label style="font-size:13px; font-weight:900;">ì•„ì´ë””</label>
        <input class="login-input login-trigger" id="loginUser" placeholder="ì•„ì´ë””">

        <label style="font-size:13px; font-weight:900;">ë¹„ë°€ë²ˆí˜¸</label>
        <input class="login-input login-trigger" id="loginPass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">

        <button class="btn-primary" id="btnLogin">ë¡œê·¸ì¸</button>
        <button class="btn-ghost" id="btnGuest">ë¹„íšŒì› ì…ì¥</button>

        <div class="login-links">
          <button class="link-btn" id="btnShowSignup">íšŒì›ê°€ì…</button>
          <button class="link-btn" id="btnShowReset">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</button>
        </div>

        <div id="authExtra" class="hidden">
          <div id="signupPane" class="hidden">
            <div style="font-weight:900; margin-bottom:10px;">íšŒì›ê°€ì…</div>
            <input class="login-input" id="suUser" placeholder="ìƒˆ ì•„ì´ë””">
            <input class="login-input" id="suPass" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
            <button class="btn-primary" id="btnDoSignup" style="margin-top:5px;">ê°€ì…í•˜ê¸°</button>
            <button class="link-btn" onclick="closeExtra()" style="width:100%; margin-top:5px;">ë‹«ê¸°</button>
          </div>
          <div id="resetPane" class="hidden">
            <div style="font-weight:900; margin-bottom:10px;">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</div>
            <input class="login-input" id="rpUser" placeholder="ê¸°ì¡´ ì•„ì´ë””">
            <input class="login-input" id="rpNewPass" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
            <button class="btn-primary" id="btnDoReset" style="margin-top:5px;">ë³€ê²½í•˜ê¸°</button>
            <button class="link-btn" onclick="closeExtra()" style="width:100%; margin-top:5px;">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="dashboardView" class="hidden">
    <div class="wrap">
      <div id="toolbar" class="hidden">
        <div class="tb-left">
          <div class="tb-logo">A</div>
          <span style="font-size:15px;">ADMIN</span>
          <span class="tb-chip" id="tbUserChip">admin</span>
        </div>

        <div class="tb-center" aria-label="service indicators">
          <div class="tb-ind" id="indWeather"><span class="dot"></span>Weather</div>
          <div class="tb-ind" id="indEnergy"><span class="dot"></span>Energy</div>
          <div class="tb-ind" id="indFx"><span class="dot"></span>FX</div>
          <div class="tb-ind" id="indTime"><span class="dot"></span>Time</div>
        </div>

        <div class="tb-right">
          <button class="tb-btn" id="tbDarkMode">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
          <button class="tb-btn" id="tbLogout">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div id="guestHeader" class="hidden">
        <button class="gbtn" id="guestLogout">ğŸ‘ˆ ë’¤ë¡œê°€ê¸°</button>
      </div>
    </div>

    <div class="wrap">
      <div class="hint-banner" id="hostHint">âš ï¸ IPë¡œ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤. <strong>cafekec.shop</strong> ë„ë©”ì¸ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>
    </div>

    <div class="page">
      <div class="wrap">
        <div class="main-area">
          <div class="quote-card">
            <div class="quote-text" id="quoteText">Loading...</div>
            <div class="quote-author" id="quoteAuthor"></div>
          </div>

          <div class="main-section">
            <div class="input-wrapper">
              <input type="text" class="question-input" id="questionInput"
                     placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë‚ ì”¨, ë¯¸ì„¸ë¨¼ì§€, ì¸í”„ë¼, ì¿ ë²„, ì „ë ¥ ë“±)" autocomplete="off">
              <button class="send-button" id="sendButton">â–²</button>
            </div>

            <div class="example-questions">
              <button class="example-btn" data-question="ì˜¤ëŠ˜ ì„œìš¸ ë‚ ì”¨ ìš”ì•½í•´ì¤˜">â˜ï¸ í˜„ì¬ ë‚ ì”¨</button>
              <button class="example-btn" data-question="ë¯¸ì„¸ë¨¼ì§€(PM10/PM2.5) ìƒíƒœ ì•Œë ¤ì¤˜">ğŸŒ«ï¸ ë¯¸ì„¸ë¨¼ì§€</button>
              <button class="example-btn" data-question="ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ë­ì•¼?">â˜¸ï¸ Kubernetes</button>
              <button class="example-btn" data-question="ìš°ë¦¬ êµ¬ì¡°ì—ì„œ Ingress VIPì™€ API VIP ì°¨ì´ ì„¤ëª…í•´ì¤˜">ğŸ§  ì•„í‚¤í…ì²˜</button>
            </div>
          </div>

          <div class="chat-topbar" id="chatTopbar">
            <button class="clear-chat-out" id="btnClearChatOuter">ëŒ€í™” ì´ˆê¸°í™”</button>
          </div>

          <div class="response-area" id="responseArea">
            <div class="chat-history" id="chatHistory"></div>
          </div>
        </div>
      </div>

      <div class="bottom-area">
        <div class="wrap">
          <div class="info-grid">
            <div class="info-card">
              <div class="info-title">ë‚ ì”¨ <span class="badge">ê¸°ìƒì²­ ì´ˆë‹¨ê¸°</span></div>
              <div class="info-value" id="weatherValue">â€”</div>
              <div class="info-sub" id="weatherSub">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="info-card">
              <div class="info-title">ê°•ìˆ˜ <span class="badge">ê¸°ìƒì²­ ì´ˆë‹¨ê¸°</span></div>
              <div class="info-value" id="rainValue">â€”</div>
              <div class="info-sub" id="rainSub">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="info-card">
              <div class="info-title">ë¯¸ì„¸ë¨¼ì§€(PM10) <span class="badge">ì„œìš¸</span></div>
              <div class="info-value" id="pm10Value">â€”</div>
              <div class="info-sub" id="pm10Sub">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="info-card">
              <div class="info-title">ì´ˆë¯¸ì„¸ë¨¼ì§€(PM2.5) <span class="badge">ì„œìš¸</span></div>
              <div class="info-value" id="pm25Value">â€”</div>
              <div class="info-sub" id="pm25Sub">ë¡œë”© ì¤‘...</div>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /page -->
  </div>

  <script>
    const AUTH_KEY = "team2_auth_v1";
    const USERS_KEY = "team2_users_v1";
    const API_BASE = "";

    // ==========================
    // âœ… AI ì„¤ì • (ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨)
    // ==========================
    const AI_MODEL = "llama3.1:latest";
    const AI_PROXY_ENDPOINT = "/api/ai/api/chat";
    const AI_DIRECT_ENDPOINT = "http://10.2.2.40:11434/api/chat";

    const WIDGETS = {
      weatherUrl: "/api/weather/weather/ultra",
      dustPm10Url: "/api/dust/seoul/pm10",
      dustPm25Url: "/api/dust/seoul/pm25",
      forecastUrl: "/api/weather/forecast",
      fxUrl: "/api/fx",
    };

    const LOCATIONS = [{ name: "ì„œìš¸", nx: 60, ny: 127 }];

    // âœ… ì¸ë””ì¼€ì´í„° ìƒíƒœ
    const IND = { weather:false, energy:false, fx:false, time:true };

    // âœ… AI ì±„íŒ… íˆìŠ¤í† ë¦¬ (ë©€í‹°í„´)
    let chatMessages = [];

    function loadUsers(){ return JSON.parse(localStorage.getItem(USERS_KEY) || "{}"); }
    function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }

    document.getElementById("btnShowSignup").onclick = () => {
      document.getElementById("authExtra").classList.remove("hidden");
      document.getElementById("signupPane").classList.remove("hidden");
      document.getElementById("resetPane").classList.add("hidden");
    };
    document.getElementById("btnShowReset").onclick = () => {
      document.getElementById("authExtra").classList.remove("hidden");
      document.getElementById("signupPane").classList.add("hidden");
      document.getElementById("resetPane").classList.remove("hidden");
    };
    window.closeExtra = () => document.getElementById("authExtra").classList.add("hidden");

    const runLogin = () => {
      const u = document.getElementById("loginUser").value.trim();
      const p = document.getElementById("loginPass").value.trim();
      if (u === "admin" && p === "admin123") {
        sessionStorage.setItem(AUTH_KEY, JSON.stringify({ user: u, role: "admin" }));
        location.reload();
      } else {
        const users = loadUsers();
        if (users[u] && users[u].pass === p) {
          sessionStorage.setItem(AUTH_KEY, JSON.stringify({ user: u, role: "user" }));
          location.reload();
        } else alert("ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      }
    };
    document.getElementById("btnLogin").onclick = runLogin;
    document.querySelectorAll(".login-trigger").forEach(el =>
      el.addEventListener("keypress", (e) => { if (e.key === "Enter") runLogin(); })
    );

    document.getElementById("btnDoSignup").onclick = () => {
      const u = document.getElementById("suUser").value.trim();
      const p = document.getElementById("suPass").value.trim();
      if (!u || !p) return alert("ì…ë ¥í•˜ì„¸ìš”");
      const users = loadUsers();
      users[u] = { pass: p };
      saveUsers(users);
      alert("ê°€ì… ì™„ë£Œ");
      closeExtra();
    };
    document.getElementById("btnDoReset").onclick = () => {
      const u = document.getElementById("rpUser").value.trim();
      const p = document.getElementById("rpNewPass").value.trim();
      const users = loadUsers();
      if (users[u]) {
        users[u].pass = p;
        saveUsers(users);
        alert("ë³€ê²½ ì™„ë£Œ");
        closeExtra();
      } else alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.");
    };

    document.getElementById("btnGuest").onclick = () => {
      sessionStorage.setItem(AUTH_KEY, JSON.stringify({ user: "Guest", role: "guest" }));
      location.reload();
    };

    const logout = () => { sessionStorage.removeItem(AUTH_KEY); location.reload(); };
    document.getElementById("tbLogout").onclick = logout;
    document.getElementById("guestLogout").onclick = logout;

    document.getElementById("tbDarkMode").onclick = () => document.body.classList.toggle("dark-mode");

    function maybeShowHostHint(){
      const host = location.hostname || "";
      const isIPv4 = /^\d{1,3}(\.\d{1,3}){3}$/.test(host);
      const hint = document.getElementById("hostHint");
      if (hint) hint.style.display = isIPv4 ? "block" : "none";
    }

    function setIndOk(elId, ok){
      const el = document.getElementById(elId);
      if (!el) return;
      el.classList.toggle("ok", !!ok);
    }
    function syncIndicators(){
      setIndOk("indWeather", IND.weather);
      setIndOk("indEnergy",  IND.energy);
      setIndOk("indFx",      IND.fx);
      setIndOk("indTime",    IND.time);
    }

    function safeNum(v){
      if (v === null || v === undefined) return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    async function loadWeatherAndRain(){
      try{
        const { nx, ny } = LOCATIONS[0];
        const url = `${API_BASE}${WIDGETS.weatherUrl}?nx=${nx}&ny=${ny}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`weather http ${res.status}`);
        const json = await res.json();

        const temp = safeNum(json.temperature_c);
        const reh  = safeNum(json.humidity_pct);
        const rain = safeNum(json.rain_1h_mm);

        if (temp !== null){
          document.getElementById("weatherValue").textContent = `${Math.round(temp)}Â°C`;
          document.getElementById("weatherSub").textContent = (reh !== null) ? `ìŠµë„ ${Math.round(reh)}%` : `ì‹¤ì‹œê°„`;
        } else {
          document.getElementById("weatherValue").textContent = "â€”";
          document.getElementById("weatherSub").textContent = "ë°ì´í„° ì—†ìŒ";
        }

        if (rain !== null){
          document.getElementById("rainValue").textContent = `${rain}mm`;
          document.getElementById("rainSub").textContent = "1ì‹œê°„ ê°•ìˆ˜(RN1)";
        } else {
          document.getElementById("rainValue").textContent = "â€”";
          document.getElementById("rainSub").textContent = "ë°ì´í„° ì—†ìŒ";
        }

        IND.weather = (temp !== null || rain !== null);
      } catch(e){
        console.error("Weather/Rain Fail:", e);
        document.getElementById("weatherValue").textContent = "N/A";
        document.getElementById("weatherSub").textContent = "ì—°ë™ ì‹¤íŒ¨";
        document.getElementById("rainValue").textContent = "N/A";
        document.getElementById("rainSub").textContent = "ì—°ë™ ì‹¤íŒ¨";
        IND.weather = false;
      }
      syncIndicators();
    }

    // âœ… ë¯¸ì„¸ë¨¼ì§€: ê¸°ì¡´ ë™ì‘ ìœ ì§€ + ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€(ì‘ë‹µ ì½”ë“œ/ë³¸ë¬¸)
    async function loadDust(kind){
      const isPm10 = kind === "pm10";
      const url = isPm10 ? WIDGETS.dustPm10Url : WIDGETS.dustPm25Url;

      const valueEl = document.getElementById(isPm10 ? "pm10Value" : "pm25Value");
      const subEl   = document.getElementById(isPm10 ? "pm10Sub"   : "pm25Sub");

      try{
        const fullUrl = `${API_BASE}${url}`;
        const res = await fetch(fullUrl);

        // âœ… ë””ë²„ê·¸: status / body ì¼ë¶€
        if (!res.ok){
          let body = "";
          try { body = await res.text(); } catch(_){}
          console.error("[DUST] HTTP FAIL", { kind, url: fullUrl, status: res.status, body: body?.slice?.(0, 500) });
          throw new Error(`dust http ${res.status}`);
        }

        const json = await res.json();
        console.log("[DUST] OK", { kind, url: fullUrl, json });

        const payload = isPm10 ? json.pm10 : json.pm25;
        const grade = payload?.grade;
        const value = safeNum(payload?.value);

        const dtF = json?.dataTime_forecast || "";
        const dtR = json?.dataTime_realtime || "";
        const dt = dtR || dtF || "ì‹¤ì‹œê°„";

        if (value !== null){
          valueEl.textContent = `${value}`;
          subEl.textContent = `${grade || "â€”"} Â· ${dt}`;
          IND.weather = true; // ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€
        } else {
          valueEl.textContent = "â€”";
          subEl.textContent = "ë°ì´í„° ì—†ìŒ";
        }
      } catch(e){
        console.error("Dust Fail:", kind, e);
        valueEl.textContent = "N/A";
        subEl.textContent = "ì—°ë™ ì‹¤íŒ¨";
      }
      syncIndicators();
    }

    async function refreshWidgets(){
      IND.weather = false; IND.energy = false; IND.fx = false; IND.time = true;
      await Promise.allSettled([
        loadWeatherAndRain(),
        loadDust("pm10"),
        loadDust("pm25"),
      ]);
      syncIndicators();
    }

    function loadQuote(){
      const list = [
        { t: "Simplicity is the soul of efficiency.", a: "Austin Freeman" },
        { t: "Code never lies.", a: "Ron Jeffries" },
        { t: "First, solve the problem. Then, write the code.", a: "John Johnson" },
      ];
      const r = list[Math.floor(Math.random() * list.length)];
      document.getElementById("quoteText").textContent = r.t;
      document.getElementById("quoteAuthor").textContent = "- " + r.a;
    }

    function scrollChatToBottom(){
      const el = document.getElementById("chatHistory");
      if (!el) return;
      el.scrollTop = el.scrollHeight;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function nl2brEscaped(str){
      return escapeHtml(str).replaceAll("\n","<br/>");
    }

    function openChatUI(){
      document.getElementById("responseArea").classList.add("active");
      document.getElementById("chatTopbar").classList.add("active");
    }

    function closeChatUI(){
      document.getElementById("responseArea").classList.remove("active");
      document.getElementById("chatTopbar").classList.remove("active");
    }

    function appendChat(role, text, opts={}){
      const hist = document.getElementById("chatHistory");
      const isUser = role === "user";
      const id = opts.id ? ` id="${opts.id}"` : "";
      const bubble = `<div class="chat-bubble">${nl2brEscaped(text)}</div>`;
      hist.innerHTML += `<div class="chat-msg${isUser ? " user": ""}"${id}>${bubble}</div>`;
      scrollChatToBottom();
    }

    function setChatBubbleById(id, text, isError=false){
      const el = document.getElementById(id);
      if (!el) return;
      const color = isError ? " style='color:#ef4444;font-weight:900;'" : "";
      el.innerHTML = `<div class="chat-bubble"${color}>${nl2brEscaped(text)}</div>`;
      scrollChatToBottom();
    }

    async function callAI(messages){
      const payload = { model: AI_MODEL, messages, stream: false };

      try{
        const res = await fetch(AI_PROXY_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`proxy http ${res.status}`);
        const data = await res.json();

        const content =
          data?.message?.content ??
          data?.choices?.[0]?.message?.content ??
          data?.response ??
          null;

        if (!content) throw new Error("proxy response invalid");
        return { via: "proxy", content };
      } catch(e1){
        console.warn("AI proxy failed, fallback to direct:", e1.message);
      }

      const res2 = await fetch(AI_DIRECT_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res2.ok) throw new Error(`direct http ${res2.status}`);
      const data2 = await res2.json();
      const content2 = data2?.message?.content;
      if (!content2) throw new Error("direct response invalid");
      return { via: "direct", content: content2 };
    }

    async function sendQuestion(){
      const inp = document.getElementById("questionInput");
      const q = inp.value.trim();
      if (!q) return;

      openChatUI();

      appendChat("user", q);
      inp.value = "";

      chatMessages.push({ role: "user", content: q });

      const loadingId = "loading-" + Date.now();
      appendChat("assistant", "Thinking...", { id: loadingId });

      try{
        const { via, content } = await callAI(chatMessages);
        setChatBubbleById(loadingId, content, false);
        chatMessages.push({ role: "assistant", content });
        console.log("AI answered via:", via);
      } catch(e){
        console.error("AI Error:", e);
        setChatBubbleById(loadingId,
          "AI í˜¸ì¶œ ì‹¤íŒ¨: " + e.message +
          "\n(ìš´ì˜ ê¶Œì¥: /api/ai í”„ë¡ì‹œë¡œ Ollamaì— ë¶™ì´ê¸°. directëŠ” CORSì— ë§‰í ìˆ˜ ìˆìŒ)",
          true
        );
      }
    }

    document.getElementById("sendButton").onclick = sendQuestion;
    document.getElementById("questionInput").addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendQuestion();
    });

    document.querySelectorAll(".example-btn").forEach(btn => btn.onclick = () => {
      document.getElementById("questionInput").value = btn.getAttribute("data-question");
      sendQuestion();
    });

    document.getElementById("btnClearChatOuter").onclick = () => {
      if (!confirm("ëŒ€í™” ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      document.getElementById("chatHistory").innerHTML = "";
      chatMessages = [];
      closeChatUI();
    };

    window.onload = () => {
      const auth = JSON.parse(sessionStorage.getItem(AUTH_KEY));
      if (auth) {
        document.getElementById("loginView").classList.add("hidden");
        document.getElementById("dashboardView").classList.remove("hidden");

        if (auth.role === "admin") {
          document.getElementById("toolbar").classList.remove("hidden");
          document.getElementById("tbUserChip").textContent = auth.user;
        } else {
          document.getElementById("guestHeader").classList.remove("hidden");
        }

        maybeShowHostHint();
        loadQuote();
        syncIndicators();

        refreshWidgets();
        setInterval(refreshWidgets, 60000);
      }
    };
  </script>
</body>
</html>

